<html>
  <head>
    <title>BZ2 Compression Example</title>
    <script src="bin/compressjs.min.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Choose a File</h1>

    <input type="file" id="files" name="files[]" />

    <h1>Choose a String</h1>
    <input id="text" type="text" value="Compress some strings!">
    <input id="submit" type="submit" value="Compress then decompress!">

    <h1>Output!</h1>

    <div id="output">None yet.</div>

    <script>
      (function() {
        var clearOutput = function() {
          document.getElementById('output').innerHTML = "";
        }

        var updateOutput = function(e) {
          var text = document.getElementById('output').innerHTML;
          document.getElementById('output').innerHTML = text + "<hr>" + e.target.result;
        }

        var compress = function(e) {
          // Once the data's been read, load it into a Uint8Array
          var buffer = new Uint8Array(e.target.result);

          // Compress the buffer
          var compressed = compressjs.Bzip2.compressFile(buffer);

          // Load the compressed result as a string and output it
          var outputter = new FileReader();
          outputter.onload = updateOutput;
          outputter.readAsText(new Blob([compressed]));

          // Then decompress the compressed string
          var decompressor = new FileReader();
          decompressor.onload = decompress;
          decompressor.readAsArrayBuffer(new Blob([compressed]));

          console.log("Finished compressing");
        }

        var decompress = function(e) {
          // Once the data's been read, load it into a Uint8Array
          var buffer = new Uint8Array(e.target.result);

          // Decompress the buffer
          var decompressed = compressjs.Bzip2.decompressFile(buffer);

          // Load the decompressed result as a string and output it
          var reader = new FileReader();
          reader.onload = updateOutput;
          reader.readAsText(new Blob([decompressed]));

          console.log("Finished decompressing");
        }

        var handleFileSelect = function(e) {
          clearOutput();

          // Load up the file and read it as an ArrayBuffer
          var file = e.target.files[0];
          var reader = new FileReader();
          reader.onload = decompress;
          reader.readAsArrayBuffer(file);
        }

        var handleFormSubmit = function(e) {
          clearOutput();

          // Load up the string and read it as an Array Buffer
          var text = document.getElementById('text').value;
          var reader = new FileReader();
          reader.onload = compress;
          reader.readAsArrayBuffer(new Blob([text]));
        }

        // Set up our listeners for file changes and button clicks
        document.getElementById('files').addEventListener('change', handleFileSelect, false);
        document.getElementById('submit').addEventListener('click', handleFormSubmit, false);
      })();

    </script>
  </body>
</html>
